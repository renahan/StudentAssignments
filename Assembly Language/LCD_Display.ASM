; ESlab4RY.ASM   7/21/2011
;Robert Yeager

; The objective of this lab was to count from 0-99 using the 8051 microchip and display the count on a LCD display

 .EQU COUNT, 20H
 .EQU PASS, 30H

 ;P2.0: LATCH SWITCH 
 ;P2.1: REGISTER sELECT 
 ;P2.2: READ/WRITE - SET HIGH
 ;P2.3: PAUSE
 

 START: 

 MOV COUNT, #00H	;INITIALIZE COUNT
 MOV PASS, #14H		;INITIALIZE PASS TO 20 - USED FOR TIMER TO CREATE ONE SECOND DELAY
 MOV TMOD, #01H		;SET TIMER MODE
 CLR P2.1		;RS LOW
 CLR P2.2		;R/W LOW
 NOP			;SHORT DELAY
 MOV P0, #0FH		;INITIALIZE DISPLAY
 NOP			;SHORT DELAY
 LCALL LATCH		;SET ENABLE HIGH TO LOAD DATA
 MOV P0, #01H		;CLEARING DISPLAY
 LCALL LATCH		;SET ENABLE HIGH TO LOAD DATA

 ;SETB P2.1		;RS(w)


 MAIN:

  	LCALL SETTENS	;FUNCTION TO SET THE TENS PLACE DISPLAY

	LCALL LATCH	;SET ENABLE HIGH TO LOAD DATA

 	LCALL SETONES	;FUNCTION TO SET THE ONES PLACE DISPLAY

	LCALL LATCH	;SET ENABLE HIGH TO LOAD DATA
	
	MOV PASS, #14H  ;RESET PASS TO 20

	LCALL DELAY	;ONE SECOND DELAY
  PAUSE:
	SETB P2.3
	JNB P2.3, PAUSE ;PAUSE FUNCTION

	LCALL CLEAR	;CLEAR THE DISPLAY

	LCALL LATCH	;SET ENABLE HIGH TO LOAD DATA

	SJMP MAIN

 LATCH:
  
  SETB P2.0	      ;SET ENABLE HIGH TO LOAD DATA
  NOP
  CLR  P2.0	      ;CLEAR ENABLE
 
  MOV TH0, #0F8H      ;SETTING UPPER BYTE OF LOADED VALUE
  MOV TL0, #2FH       ;SETTING LOWER BYTE OF LOADED VALUE
  SETB TR0            ;START TIMER
   WAIT1:
    JNB TF0, WAIT1    ;IF FLAG IS SET STOP DELAY LOOP
   CLR TR0            ; CLEAR FLAG TR0
   CLR TF0            ; CLEAR FLAG TF0

  RET

 SETTENS:
  
  MOV A, COUNT	      ;MOVE COUNT TO ACCUMULATOR
  SWAP A	      ;SWAP UPPER BITS WITH LOWER BITS
  ANL A, #0FH	      ;MASK LOWER BITS
  ADD A, #30H	      ;ADD 30HEX TO CORRESPOND WITH CORRECT VALUE IN TABLE FOR LCD DISPLAY
  MOV P0, A	      ;LOAD ACCUM TO OUTPUT TO DISPLAY
  RET 

 SETONES:
 
  MOV A, COUNT	      ;MOVE COUNT TO ACCUM
  ANL A, #0FH 	      ;MASK LOWER BITS
  ADD A, #30H	      ;ADD 30HEX TO CORRESPOND WITH CORRECT VALUE IN TABLE FOR LCD DISPLAY
  MOV P0, A	      ;LOAD ACCUM TO OUTPUT TO DISPLAY
  RET

 CLEAR: 	      

  CLR P2.2	      ;CLEAR READ/WRITE
  MOV P0, #01H	      
  SETB P2.0	      ;LATCH
  CLR P2.0
  SETB P2.2
  RET

 DELAY: 
  
  MOV TH0, #3CH       ;SETTING UPPER BYTE OF LOADED VALUE
  MOV TL0, #0AFH      ;SETTING LOWER BYTE OF LOADED VALUE
  SETB TR0            ;START TIMER
   WAIT:
    JNB TF0, WAIT     ;IF FLAG IS SET STOP DELAY LOOP
   CLR TR0            ; CLEAR FLAG TR0
   CLR TF0            ; CLEAR FLAG TF0
  DJNZ PASS, DELAY    ;IF PASS IS NOT EQUAL TO ZERO, JUMP TO LOOP 2
 

 INCREMENT:
  
  MOV A, COUNT	      ;MOVE COUNT TO ACCUM
  ADD A, #01H	      ;ADD ONE TO ACCUM
  DA A		      ;DECIMAL ADJUST
  MOV COUNT, A	      ;MOVE ACCUM TO COUNT
  RET

 .END